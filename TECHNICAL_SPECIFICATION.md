
---

### **Финальное техническое задание на разработку Telegram-бота «FoodLens»** (Ревизия 3)

**1. Общее описание**
FoodLens — Telegram-бот для анализа еды по фото и текстовым описаниям:
- Определяет калории, БЖУ, клетчатку
- Выдает примерный рецепт блюда
- Ведет дневник питания с отчетами
- Поддерживает премиум-подписку через Telegram Stars

**Целевая аудитория:** Россия, мужчины/женщины 20–40 лет, интересующиеся контролем питания

**2. Архитектура и стек**
- **Backend:** Python + Aiogram
- **AI:** OpenAI API (оптимальная связка моделей)
- **База данных:** PostgreSQL
- **Конфиги:** YAML (тексты, промты, тарифы)
- **Дашборды:** Metabase + Grafana + Prometheus
- **Инфраструктура:** Docker, VPS (2vCPU, 4GB RAM)

**3. Конфигурации**
```yaml
# /configs/pricing.yaml
subscription:
  monthly_price_stars: 30
  yearly_price_stars: 250
  trial_days: 3
limits:
  free:
    photo_per_day: 3
    text_per_day: 10
    text_max_chars: 100
  premium:
    photo_per_day: 10
    text_per_day: 30
    text_max_chars: 300
```

**4. User Stories**

**US1. Анализ блюда**
1. Пользователь отправляет фото
2. Бот: «Фото получено. Можешь уточнить детали блюда текстом. Когда закончишь — нажми Анализировать»
3. Пользователь отправляет 0–N сообщений → сохраняются в text_inputs[]
4. Нажатие «Анализировать» → отправка в OpenAI
5. Результат с inline-кнопками (жизненный цикл 12 часов):
   - «Добавить в дневник»
   - «Рецепт»

**US2. Дневник питания**
- Inline-кнопка «Добавить в дневник» → сохранение в food_log
- Ежедневный отчет в 23:00
- Возможность удаления через кнопку «Убрать из дневника»

**US3. Статистика**
- Команда /stats с вариантами: «За день», «За неделю», «За месяц»
- Сравнение с целью по калориям

**US4. Профиль и цели**
- Команда /profile: информация о подписке, установка цели по калориям, смена языка

**US5. Подписка**
- Оформление через Telegram Stars
- Преимущества: увеличенные лимиты, статистика, цели, нет рекламы

**5. Тексты бота**
```yaml
# /configs/texts/ru.yaml
start_free: |
  Привет! Я FoodLens — бот для анализа еды по фото и описанию. 
  Ты можешь отправить до 3 фото и до 10 текстовых описаний в день.
  Если блюдо на фото непонятно, я попрошу уточнение — просто ответь текстом и нажми Анализировать.
  Хочешь больше возможностей и отсутствие рекламы? Попробуй подписку!

start_premium: |
  Привет! У тебя активна премиум-подписка: доступно до 10 фото и 30 описаний в день.
  Ты можешь видеть подробную статистику, цели по калориям, получать расширенные уточнения и не видеть рекламы.

photo_received: «Фото получено. Можешь уточнить детали блюда текстом. Когда закончишь — нажми Анализировать.»

text_received: «Описание получил. Нажми Анализировать, чтобы я посчитал КБЖУ.»

analysis_result: |
  Вот что у меня получилось:
  • Блюдо: {title}
  • Вес: {weight} г
  • Калории: {kcal} ккал
  • Белки: {protein} г
  • Жиры: {fat} г  
  • Углеводы: {carbs} г
  • Клетчатка: {fiber} г

need_clarification: «Мне нужно немного больше информации. Пожалуйста, уточни детали одним сообщением. Когда закончишь — нажми Анализировать.»

added_to_diary: «Добавил блюдо в дневник!»
removed_from_diary: «Убрал блюдо из дневника.»

recipe: «Вот рецепт блюда: {recipe}. Помни, это ориентировочный вариант.»

daily_report: |
  Сегодня ты съел:
  {dishes_list}
  Итого: {total_kcal} ккал.

premium_benefits: |
  Премиум дает:
  • 10 фото блюд в день
  • 30 текстовых описаний  
  • Статистику по дням/неделям/месяцам
  • Возможность ставить цель по калориям
  • Расширенные уточнения
  • Нет рекламы
```

**6. Промты OpenAI**
```yaml
# /configs/prompts.yaml
analysis_prompt: |
  Ты — эксперт по анализу питания. Проанализируй фото еды и текстовые уточнения.
  Верни ТОЛЬКО JSON без форматирования и комментариев.
  
  Структура JSON:
  {
    "title": "Название блюда",
    "weight": 250,
    "kcal": 350, 
    "protein": 15,
    "fat": 10,
    "carbs": 45,
    "fiber": 5,
    "ingredients": ["ингредиент1", "ингредиент2"],
    "recipe": "Текст рецепта"
  }
  
  Правила:
  - Вес указывай в граммах для всего блюда
  - КБЖУ и клетчатку — в граммах для всего блюда
  - Если информации недостаточно — делай обоснованное предположение
  - Рецепт должен быть кратким, на 2-3 предложения

recipe_prompt: |
  На основе анализа блюда создай краткий рецепт. Только текст, 2-3 предложения.
```

**7. База данных**
```sql
users:
  user_id (BigInt), created_at (Timestamp), language (Varchar), 
  trial_used (Boolean), subscription_until (Timestamp),
  daily_calorie_goal (Integer)

food_log:
  id (Serial), user_id (BigInt), session_id (Varchar),
  name (Varchar), kcal (Integer), protein (Real), fat (Real), 
  carbs (Real), fiber (Real), weight (Integer),
  date (Date), eaten (Boolean)

analysis_sessions:
  session_id (Varchar), user_id (BigInt),
  photo_file_id (Varchar), text_inputs (JSONB),
  result_json (JSONB), created_at (Timestamp),
  timeout_at (Timestamp)
```

**8. Монетизация**
- Подписка через Telegram Stars (месяц — 30⭐, год — 250⭐)
- На этапе разработки — эмуляция платежей
- Расчет ROI: `(доход_подписок) - (расход_на_OpenAI + сервер)`

**9. Аналитика и мониторинг**
- **Metabase:** DAU/WAU/MAU, конверсия в подписку, топ блюд
- **Grafana:** Мониторинг нагрузки, ошибок API, времени ответа
- **Метрики:** расход OpenAI, среднее время анализа, retention

**10. Важные технические детали**
- **Изображения:** Не храним, используем `photo_file_id` из Telegram
- **Сессии анализа:** Таймаут 30 минут после создания
- **Inline-кнопки:** Данные в callback'е работают 12 часов
- **Обработка ошибок:** Отдельные тексты для ошибок API, лимитов, сети-



